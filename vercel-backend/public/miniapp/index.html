<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Air24 • Mini App</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a; --fg: #e2e8f0; --card: #111827; --accent: #22c55e;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); }
    .wrap { min-height: 100dvh; display: grid; place-items:center; padding: 24px; }
    .card { width: min(680px, 100%); background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 6px; font-weight: 700; font-size: 22px; }
    p { margin: 0 0 14px; opacity: .85; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { appearance:none; border:0; border-radius:10px; padding:12px 16px; background:#16a34a; color:white; font-weight:600; cursor:pointer; }
    button.secondary { background:#334155; }
    pre { background:#0b0f1a; padding:12px; border-radius:10px; overflow:auto; max-height:320px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { opacity:.7 }
    .ok { color: var(--accent); }
    .err { color: #ef4444; }
    a { color: #60a5fa; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Air24 Mini App</h1>
      <p class="muted">Verify with World ID from inside World App. If you open this page in a normal browser, the Verify button will be disabled.</p>

      <div class="row" style="margin:12px 0 16px">
        <button id="btn-verify" disabled>Verify with World ID</button>
        <button id="btn-open" class="secondary" title="Open in World App">Open in World App</button>
      </div>

      <div class="mono" style="margin:12px 0 8px">Status: <span id="status">Initializing…</span></div>
      <pre id="log" class="mono" aria-live="polite"></pre>

      <div class="muted mono" style="margin-top:8px">
        Backend: <span id="backend">/api/worldid-verify</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { MiniKit, VerificationLevel } from 'https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1/+esm';

    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const btnVerify = document.getElementById('btn-verify');
    const btnOpen = document.getElementById('btn-open');

    const qs = new URLSearchParams(location.search);
    const ACTION = qs.get('action') || 'flight-compensation-verify';
    const LEVEL = (qs.get('level') || 'orb').toLowerCase();

    const append = (msg) => { logEl.textContent += `${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };

    const openInWorldAppUrl = () => {
      // World App deep link that opens this URL inside the app
      const url = encodeURIComponent(location.href);
      return `worldapp://link?url=${url}`;
    };

    // Detect World App environment
    const installed = MiniKit.isInstalled();
    if (installed) {
      statusEl.textContent = 'Running inside World App ✅';
      btnVerify.disabled = false;
    } else {
      statusEl.textContent = 'Open this page inside World App to verify.';
      btnVerify.disabled = true;
    }

    btnOpen.addEventListener('click', () => {
      location.href = openInWorldAppUrl();
    });

    btnVerify.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'Requesting verification…';
        append(`Calling MiniKit.verify for action=\"${ACTION}\", level=\"${LEVEL}\"`);

        const { finalPayload } = await MiniKit.commandsAsync.verify({
          action: ACTION,
          verification_level: LEVEL === 'device' ? VerificationLevel.Device : VerificationLevel.Orb,
        });

        if (finalPayload.status === 'error') {
          append(`MiniKit error: ${JSON.stringify(finalPayload, null, 2)}`);
          statusEl.textContent = 'Verification failed in World App';
          return;
        }

        append('Got proof from World App. Verifying on backend…');

        const resp = await fetch('/api/worldid-verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nullifier_hash: finalPayload.nullifier_hash,
            merkle_root: finalPayload.merkle_root,
            proof: finalPayload.proof,
            verification_level: finalPayload.verification_level,
            action: ACTION,
          })
        });

        const data = await resp.json();
        if (!resp.ok || data?.success === false) {
          append(`Backend verify failed: ${JSON.stringify(data, null, 2)}`);
          statusEl.textContent = 'Backend verification failed';
          return;
        }

        append(`Backend verify success: ${JSON.stringify(data, null, 2)}`);
        statusEl.innerHTML = 'Verified <span class="ok">successfully</span>!';
      } catch (err) {
        append(`Exception: ${err?.message || err}`);
        statusEl.innerHTML = 'Unexpected <span class="err">error</span>';
      }
    });
  </script>
</body>
</html>
